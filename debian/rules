#!/usr/bin/make -f

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

include /usr/share/pkg-kde-tools/makefiles/1/variables.mk
include /usr/share/quilt/quilt.make

DEB_DESTDIR = $(CURDIR)/debian/tmp

builddir/Makefile: $(QUILT_STAMPFN)
	dh_testdir

	mkdir -p builddir
	cd builddir && cmake .. \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_C_FLAGS="$(CFLAGS)" \
		-DCMAKE_LD_FLAGS="-Wl,-z,defs" \
		-DCMAKE_CXX_FLAGS="$(CXXFLAGS)" \
		-DCMAKE_SKIP_RPATH=ON \
		-DCMAKE_VERBOSE_MAKEFILE=ON \
		$(DEB_CMAKE_KDE4_FLAGS)

build: build-stamp
build-stamp: builddir/Makefile
	dh_testdir

	$(MAKE) -C builddir

	touch $@

clean: unpatch
	dh_testdir
	dh_testroot
	rm -f build-stamp

	rm -rf builddir

	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_prep
	dh_installdirs

	$(MAKE) -C builddir DESTDIR=$(DEB_DESTDIR) install

	# Install pixmap
	install -D -p -m0644 debian/kile.xpm $(DEB_DESTDIR)/usr/share/pixmaps/kile.xpm

	# Fix lintian warning: script-not-executable
	chmod +x $(DEB_DESTDIR)/usr/share/kde4/apps/kile/test/runTests.sh
	chmod +x $(DEB_DESTDIR)/usr/share/kde4/apps/kconf_update/kile*_upd.pl

	# Syntax files bibtex.xml and latex.xml are provided by kdelibs5-data package.
	find $(DEB_DESTDIR) -type f -name bibtex.xml | xargs rm -f
	find $(DEB_DESTDIR) -type f -name latex.xml | xargs rm -f

	# Fix lintian warning: package-contains-readme-for-other-platform-or-distro
	find $(DEB_DESTDIR) -type f -name README.MacOSX | xargs rm -f

# Build architecture-independent files here.
binary-indep: install
# We have nothing to do by default.

# Build architecture-dependent files here.
binary-arch: install
	dh_testdir
	dh_testroot
	dh_installchangelogs ChangeLog
	dh_installdocs
	dh_installexamples
	dh_install --list-missing
	dh_installmenu
	dh_installman debian/kile.1
	dh_link
	dh_strip
	dh_compress --exclude=.docbook
	dh_fixperms
	dh_makeshlibs
	dh_installdeb
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install 
